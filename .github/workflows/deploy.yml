name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    if: false # disables this job regardless of trigger
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway login --token $RAILWAY_TOKEN
          railway up --service railway-app

      - name: Wait for deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Wait for deployment to complete (max 10 minutes)
          timeout 600 bash -c '
            while ! railway status --service railway-app | grep -q "Ready\|Succeeded"; do
              echo "Waiting for deployment..."
              sleep 30
            done
            echo "Deployment completed!"
          '

      - name: Health check
        run: |
          # Wait for app to be ready
          sleep 60

          # Get Railway app URL
          APP_URL=$(railway domain --service railway-app)
          echo "App deployed to: $APP_URL"

          # Perform health check
          curl -f "$APP_URL/health" || exit 1
          echo "Health check passed!"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
